#!/bin/sh
set -e

# Configure /boot/firmware/config.txt for display driver
CONFIG_FILE="/boot/firmware/config.txt"
if [ ! -f "$CONFIG_FILE" ]; then
    CONFIG_FILE="/boot/config.txt"  # Fallback for older Raspberry Pi OS
fi

if [ -f "$CONFIG_FILE" ]; then
    # Enable SPI if not already enabled
    if ! grep -q "^dtparam=spi=on" "$CONFIG_FILE"; then
        echo "dtparam=spi=on" >> "$CONFIG_FILE"
    fi

    # Configure SPI buffer size for DMA transfers (65536 bytes)
    if ! grep -q "^spidev_bufsiz=" "$CONFIG_FILE"; then
        echo "spidev_bufsiz=65536" >> "$CONFIG_FILE"
    fi

    # Enable CMA (Contiguous Memory Allocator) for GPU Mailbox and zero-copy DMA
    CMA_REQUIRED=16
    if grep -q "^cma=" "$CONFIG_FILE"; then
        # CMA is already set, check if value is sufficient
        cma_line=$(grep "^cma=" "$CONFIG_FILE")
        cma_value=$(echo "$cma_line" | sed 's/^cma=//' | sed 's/[^0-9].*//')

        if [ "$cma_value" -lt "$CMA_REQUIRED" ]; then
            # CMA is too small, update it
            sed -i 's/^cma=.*/cma=16M/' "$CONFIG_FILE"
            echo "WARNING: CMA value was too low (${cma_line#*=}), updated to 16M"
        elif [ "$cma_value" -gt "$CMA_REQUIRED" ]; then
            # CMA is larger than required, inform user
            echo "INFO: CMA is set to ${cma_line#*=}. Please verify it meets requirements"
            echo "      for all your applications. This package requires minimum 16M."
        fi
    else
        # CMA is not set, add it
        echo "cma=16M" >> "$CONFIG_FILE"
    fi

    # Allocate sufficient GPU memory for framebuffers (32MB is sufficient for 320x480 RGB666 display)
    GPU_MEM_REQUIRED=32
    if grep -q "^gpu_mem=" "$CONFIG_FILE"; then
        # GPU memory is already set, check if value is sufficient
        gpu_mem_line=$(grep "^gpu_mem=" "$CONFIG_FILE")
        gpu_mem_value=$(echo "$gpu_mem_line" | sed 's/^gpu_mem=//')

        if [ "$gpu_mem_value" -lt "$GPU_MEM_REQUIRED" ]; then
            # GPU memory is too small, update it
            sed -i 's/^gpu_mem=.*/gpu_mem=32/' "$CONFIG_FILE"
            echo "WARNING: GPU memory was too low (${gpu_mem_line#*=}), updated to 32"
        elif [ "$gpu_mem_value" -gt "$GPU_MEM_REQUIRED" ]; then
            # GPU memory is larger than required, inform user
            echo "INFO: GPU memory is set to ${gpu_mem_line#*=}. Please verify it meets requirements"
            echo "      for all your applications. This package requires minimum 32."
        fi
    else
        # GPU memory is not set, add it
        echo "gpu_mem=32" >> "$CONFIG_FILE"
    fi

    # Configure GPIO pins for display control (DC=24, RESET=25)
    if ! grep -q "gpio=24=op" "$CONFIG_FILE"; then
        echo "gpio=24=op" >> "$CONFIG_FILE"
    fi
    if ! grep -q "gpio=25=op" "$CONFIG_FILE"; then
        echo "gpio=25=op" >> "$CONFIG_FILE"
    fi
fi

# Configure SPI buffer size via modprobe for kernel module
MODPROBE_CONF="/etc/modprobe.d/spidev.conf"
if ! grep -q "bufsiz=65536" "$MODPROBE_CONF" 2>/dev/null; then
    echo "options spidev bufsiz=65536" > "$MODPROBE_CONF"
fi

if command -v systemctl >/dev/null 2>&1; then
    systemctl daemon-reload || true
    systemctl enable ili9488-daemon.service || true
    # Restart if already running (picks up new binary + service file)
    if systemctl is-active --quiet ili9488-daemon.service; then
        systemctl restart ili9488-daemon.service || true
    else
        systemctl start ili9488-daemon.service || true
    fi
fi

# Inform user about required reboot
echo ""
echo "=========================================="
echo "ili9488-daemon installation completed!"
echo "=========================================="
echo ""
echo "IMPORTANT: You must reboot your Raspberry Pi for the following changes to take effect:"
echo "  - /boot/config.txt modifications (SPI, CMA, GPU memory, GPIO)"
echo "  - SPI buffer size configuration (/etc/modprobe.d/spidev.conf)"
echo ""
echo "Please run: sudo reboot"
echo ""

exit 0
